rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }

    // invoices
    match /invoices/{invoiceId} {
      // Owner-only access
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.invoiceID == invoiceId
        && request.resource.data.amount is number
        && request.resource.data.status in ['paid','pending']
        && request.resource.data.date is timestamp
        && request.resource.data.bookingID is string
        && request.resource.data.plateNumber is string;

      // Only allow status change (e.g., pending -> paid) by owner
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status'])
        && request.resource.data.status in ['paid','pending'];

      allow delete: if false;
    }

    // payments
    match /payments/{paymentId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.paymentID == paymentId
        && request.resource.data.invoiceID is string
        && request.resource.data.amount is number
        && request.resource.data.status in ['paid','pending']
        && request.resource.data.paymentDate is timestamp
        && request.resource.data.paymentTime is string;

      allow update, delete: if false;
    }

    // feedbacks
    match /feedbacks/{feedbackId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      allow create, update: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.feedbackID == feedbackId
        && request.resource.data.invoiceID is string
        && request.resource.data.rating is number
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && request.resource.data.comment is string
        && request.resource.data.date is timestamp;

      allow delete: if false;
    }
  }
}
